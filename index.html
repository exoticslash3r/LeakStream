<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LeakStream Publisher</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: Arial, sans-serif; background: #000; color: #fff; padding: 20px; }

.container { max-width: 800px; margin: 0 auto; }
.header { background: #111; padding: 20px; border: 1px solid #333; margin-bottom: 30px; text-align: center; }
.header h1 { color: #fff; font-size: 1.5rem; }

.form-container { background: #111; padding: 25px; border: 1px solid #333; border-radius: 5px; }
.form-group { margin-bottom: 20px; }
.form-group label { display: block; color: #888; margin-bottom: 8px; font-size: 0.9rem; }
.form-control { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: #fff; font-size: 1rem; border-radius: 3px; }
.form-control:focus { outline: none; border-color: #666; }
textarea.form-control { min-height: 100px; resize: vertical; }

.radio-group { display: flex; gap: 20px; margin-top: 10px; }
.radio-option { display: flex; align-items: center; gap: 8px; cursor: pointer; }
.radio-option input[type="radio"] { margin: 0; }

.btn { padding: 12px 24px; background: #000; color: #fff; border: 1px solid #333; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.3s; }
.btn:hover { background: #222; border-color: #666; }
.btn-primary { background: #111; border-color: #fff; }
.btn-primary:hover { background: #222; }

.upload-area { border: 2px dashed #333; padding: 30px; text-align: center; margin: 20px 0; cursor: pointer; transition: all 0.3s; }
.upload-area:hover { border-color: #666; background: #1a1a1a; }
.upload-area.dragover { border-color: #fff; background: #222; }
.upload-icon { font-size: 2rem; margin-bottom: 10px; }
.file-name { color: #666; margin-top: 10px; font-size: 0.9rem; }

.preview { margin: 20px 0; }
.preview img, .preview video { max-width: 100%; max-height: 300px; display: block; margin: 10px auto; background: #000; }

.status { padding: 15px; margin: 20px 0; border-radius: 3px; display: none; }
.status.success { background: #1a3a1a; border: 1px solid #2d5a2d; color: #8f8; display: block; }
.status.error { background: #3a1a1a; border: 1px solid #5a2d2d; color: #f88; display: block; }
.status.loading { background: #2a2a2a; border: 1px solid #444; color: #aaa; display: block; text-align: center; }

.actions { display: flex; justify-content: space-between; margin-top: 30px; }
.counter { color: #666; font-size: 0.8rem; text-align: right; margin-top: 5px; }

.nav { margin-bottom: 20px; display: flex; justify-content: space-between; }
.nav-btn { padding: 10px 20px; background: #111; color: #fff; border: 1px solid #333; text-decoration: none; }
.nav-btn:hover { background: #222; }

@media (max-width: 768px) {
body { padding: 10px; }
.radio-group { flex-direction: column; gap: 10px; }
.actions { flex-direction: column; gap: 10px; }
.actions .btn { width: 100%; }
}
</style>
</head>
<body>
<div class="container">
<div class="nav">
<a href="viewer.html" class="nav-btn">← Back to Viewer</a>
<a href="#" class="nav-btn" onclick="showStats()">Stats</a>
</div>

<div class="header">
<h1>LEAKSTREAM PUBLISHER</h1>
<p>Upload content to the stream</p>
</div>

<div class="form-container">
<div id="status" class="status"></div>

<div class="form-group">
<label for="title">Title *</label>
<input type="text" id="title" class="form-control" placeholder="Enter post title" maxlength="100">
<div class="counter"><span id="titleCount">0</span>/100</div>
</div>

<div class="form-group">
<label for="content">Content (Optional)</label>
<textarea id="content" class="form-control" placeholder="Enter description or text content" maxlength="1000"></textarea>
<div class="counter"><span id="contentCount">0</span>/1000</div>
</div>

<div class="form-group">
<label>Media Type</label>
<div class="radio-group">
<label class="radio-option">
<input type="radio" name="mediaType" value="none" checked> None (Text Only)
</label>
<label class="radio-option">
<input type="radio" name="mediaType" value="image"> Image
</label>
<label class="radio-option">
<input type="radio" name="mediaType" value="video"> Video
</label>
</div>
</div>

<div class="form-group" id="mediaUrlGroup" style="display: none;">
<label for="mediaUrl">Media URL *</label>
<input type="url" id="mediaUrl" class="form-control" placeholder="https://example.com/image.jpg">
<div id="uploadArea" class="upload-area">
<div class="upload-icon">⬆️</div>
<div>Drag & drop file or click to select</div>
<div>Supports: JPG, PNG, GIF, MP4, WebM</div>
<input type="file" id="fileInput" style="display: none;" accept="image/*,video/*">
<div id="fileName" class="file-name"></div>
</div>
<div id="preview" class="preview"></div>
</div>

<div class="actions">
<button class="btn" onclick="clearForm()">Clear</button>
<button class="btn btn-primary" onclick="publishPost()">Publish</button>
</div>
</div>

<div id="statsPanel" style="display: none; margin-top: 30px; padding: 20px; background: #111; border: 1px solid #333;">
<h3>Statistics</h3>
<p>Total Posts: <span id="totalPosts">0</span></p>
<p>Today's Posts: <span id="todayPosts">0</span></p>
<button class="btn" onclick="hideStats()" style="margin-top: 15px;">Close</button>
</div>
</div>

<script>
// Firebase Configuration (SAME AS YOUR VIEWER)
const firebaseConfig = {
apiKey: "AIzaSyAyTSyWhLVe22jynP94cp9OEg6IC5-OhdE",
authDomain: "leakstream-4f62f.firebaseapp.com",
projectId: "leakstream-4f62f",
storageBucket: "leakstream-4f62f.firebasestorage.app",
messagingSenderId: "886997714546",
appId: "1:886997714546:web:b7fcbb9b28010d5ec564eb",
measurementId: "G-RXHE019ZWT"
};

let db = null;
let storage = null;

// Initialize Firebase
function initFirebase() {
try {
// Load Firebase SDKs
const script1 = document.createElement('script');
script1.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js';
script1.onload = () => {
const script2 = document.createElement('script');
script2.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js';
script2.onload = () => {
const script3 = document.createElement('script');
script3.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js';
script3.onload = () => {
firebase.initializeApp(firebaseConfig);
db = firebase.firestore();
storage = firebase.storage();
console.log("Firebase initialized for publisher");
loadStats();
};
document.head.appendChild(script3);
};
document.head.appendChild(script2);
};
document.head.appendChild(script1);
} catch (error) {
console.error("Firebase error:", error);
showStatus("Error connecting to database", "error");
}
}

// Character counters
document.getElementById('title').addEventListener('input', function() {
document.getElementById('titleCount').textContent = this.value.length;
});

document.getElementById('content').addEventListener('input', function() {
document.getElementById('contentCount').textContent = this.value.length;
});

// Media type toggle
document.querySelectorAll('input[name="mediaType"]').forEach(radio => {
radio.addEventListener('change', function() {
const mediaUrlGroup = document.getElementById('mediaUrlGroup');
if (this.value === 'none') {
mediaUrlGroup.style.display = 'none';
document.getElementById('mediaUrl').required = false;
} else {
mediaUrlGroup.style.display = 'block';
document.getElementById('mediaUrl').required = true;
}
clearPreview();
}
);
});

// File upload handling
document.getElementById('uploadArea').addEventListener('click', () => {
document.getElementById('fileInput').click();
});

document.getElementById('fileInput').addEventListener('change', handleFileSelect);

// Drag and drop
const uploadArea = document.getElementById('uploadArea');
uploadArea.addEventListener('dragover', (e) => {
e.preventDefault();
uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
e.preventDefault();
uploadArea.classList.remove('dragover');
if (e.dataTransfer.files.length) {
handleFileSelect({ target: { files: e.dataTransfer.files } });
}
});

function handleFileSelect(e) {
const file = e.target.files[0];
if (!file) return;

document.getElementById('fileName').textContent = file.name;

// Show preview
const preview = document.getElementById('preview');
preview.innerHTML = '';

if (file.type.startsWith('image/')) {
const reader = new FileReader();
reader.onload = (e) => {
preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
};
reader.readAsDataURL(file);
} else if (file.type.startsWith('video/')) {
const video = document.createElement('video');
video.src = URL.createObjectURL(file);
video.controls = true;
video.style.maxWidth = '100%';
preview.appendChild(video);
}

// Upload to Firebase Storage
uploadToStorage(file);
}

async function uploadToStorage(file) {
showStatus("Uploading file...", "loading");

try {
const storageRef = storage.ref();
const fileRef = storageRef.child('posts/' + Date.now() + '_' + file.name);
const snapshot = await fileRef.put(file);
const downloadURL = await snapshot.ref.getDownloadURL();

document.getElementById('mediaUrl').value = downloadURL;
showStatus("File uploaded successfully!", "success");

// Auto-select correct media type
if (file.type.startsWith('image/')) {
document.querySelector('input[value="image"]').checked = true;
document.getElementById('mediaUrlGroup').style.display = 'block';
} else if (file.type.startsWith('video/')) {
document.querySelector('input[value="video"]').checked = true;
document.getElementById('mediaUrlGroup').style.display = 'block';
}

} catch (error) {
console.error("Upload error:", error);
showStatus("Upload failed: " + error.message, "error");
}
}

// Publish post
async function publishPost() {
const title = document.getElementById('title').value.trim();
const content = document.getElementById('content').value.trim();
const mediaType = document.querySelector('input[name="mediaType"]:checked').value;
const mediaUrl = document.getElementById('mediaUrl').value.trim();

// Validation
if (!title) {
showStatus("Title is required", "error");
return;
}

if (mediaType !== 'none' && !mediaUrl) {
showStatus("Media URL is required", "error");
return;
}

showStatus("Publishing post...", "loading");

const postData = {
title: title,
content: content || null,
mediaType: mediaType !== 'none' ? mediaType : null,
mediaUrl: mediaUrl || null,
timestamp: firebase.firestore.FieldValue.serverTimestamp(),
publishedBy: "Publisher",
ipHash: "anonymous" // You could add IP hashing here
};

try {
await db.collection('posts').add(postData);
showStatus("Post published successfully!", "success");
clearForm();
loadStats(); // Refresh stats
} catch (error) {
console.error("Publish error:", error);
showStatus("Publish failed: " + error.message, "error");
}
}

// Clear form
function clearForm() {
if (confirm("Clear all fields?")) {
document.getElementById('title').value = '';
document.getElementById('content').value = '';
document.getElementById('mediaUrl').value = '';
document.querySelector('input[value="none"]').checked = true;
document.getElementById('mediaUrlGroup').style.display = 'none';
document.getElementById('fileName').textContent = '';
document.getElementById('preview').innerHTML = '';
document.getElementById('fileInput').value = '';
document.getElementById('titleCount').textContent = '0';
document.getElementById('contentCount').textContent = '0';
showStatus("Form cleared", "success");
}
}

function clearPreview() {
document.getElementById('fileName').textContent = '';
document.getElementById('preview').innerHTML = '';
document.getElementById('fileInput').value = '';
}

// Status messages
function showStatus(message, type) {
const status = document.getElementById('status');
status.textContent = message;
status.className = 'status ' + type;
setTimeout(() => {
if (type !== 'loading') {
status.style.display = 'none';
}
}, 5000);
}

// Stats functions
async function loadStats() {
if (!db) return;

try {
const snapshot = await db.collection('posts').get();
const total = snapshot.size;
document.getElementById('totalPosts').textContent = total;

// Today's posts
const today = new Date();
today.setHours(0, 0, 0, 0);
const todaySnapshot = await db.collection('posts')
.where('timestamp', '>=', today)
.get();
document.getElementById('todayPosts').textContent = todaySnapshot.size;
} catch (error) {
console.error("Stats error:", error);
}
}

function showStats() {
document.getElementById('statsPanel').style.display = 'block';
loadStats();
}

function hideStats() {
document.getElementById('statsPanel').style.display = 'none';
}

// Initialize on load
window.onload = initFirebase;
</script>
</body>
</html>
