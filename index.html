<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publish Content - LeakStream</title>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: #000; color: #fff; min-height: 100vh; 
               display: flex; justify-content: center; align-items: center; padding: 20px; }
        
        /* Blood rain */
        .blood-drop { position: absolute; width: 2px; height: 20px; background: #800; opacity: 0; 
                     animation: bloodRain linear infinite; pointer-events: none; z-index: 1; }
        @keyframes bloodRain { 
            0% { top: -20px; opacity: 1; transform: translateX(0); }
            100% { top: 100vh; opacity: 0; transform: translateX(10px); }
        }
        
        /* Scrollable container */
        .page-container { width: 100%; max-height: 95vh; overflow-y: auto; padding: 20px; }
        .page-container::-webkit-scrollbar { width: 12px; }
        .page-container::-webkit-scrollbar-track { background: #111; }
        .page-container::-webkit-scrollbar-thumb { background: #800; }
        .page-container::-webkit-scrollbar-thumb:hover { background: #a00; }
        
        /* Publish form */
        .publish-container { background: rgba(20, 20, 20, 0.95); padding: 40px; border: 3px solid #800; 
                            max-width: 700px; margin: 0 auto; }
        h1 { color: #fff; margin-bottom: 30px; text-align: center; font-size: 3rem; 
             font-family: 'UnifrakturMaguntia', cursive; border-bottom: 2px solid #800; padding-bottom: 20px; }
        
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 10px; color: #ccc; font-size: 1.2rem; 
               font-family: 'Creepster', cursive; letter-spacing: 2px; }
        input, textarea, select { width: 100%; padding: 15px; border: 2px solid #333; background: #111; 
                                 color: #fff; font-size: 1.1rem; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #800; 
                                                   box-shadow: 0 0 20px rgba(255, 0, 0, 0.3); }
        textarea { min-height: 120px; resize: vertical; }
        
        .upload-hint { font-size: 0.9rem; color: #999; margin-top: 5px; display: block; }
        .warning-hint { color: #ff4444 !important; font-weight: bold; }
        
        .hoster-links { display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        .hoster-link { flex: 1; min-width: 250px; padding: 15px; text-align: center; 
                      background: #004400; color: #0f0; text-decoration: none; border: 1px solid #0f0; 
                      font-family: 'Creepster', cursive; transition: all 0.3s; }
        .hoster-link:hover { background: #006600; transform: translateY(-3px); 
                           box-shadow: 0 0 20px rgba(0, 255, 0, 0.3); }
        .hoster-link:nth-child(2) { background: #002244; border-color: #00f; color: #88f; }
        .hoster-link:nth-child(2):hover { background: #003366; box-shadow: 0 0 20px rgba(0, 100, 255, 0.3); }
        
        .submit-btn { width: 100%; padding: 20px; background: #004400; color: #0f0; border: 2px solid #0f0; 
                     font-size: 1.5rem; cursor: pointer; margin-top: 30px; font-family: 'Creepster', cursive; 
                     letter-spacing: 3px; transition: all 0.3s; }
        .submit-btn:hover { background: #006600; box-shadow: 0 0 30px rgba(0, 255, 0, 0.4); transform: translateY(-5px); }
        .submit-btn:disabled { background: #333; color: #666; border-color: #666; cursor: not-allowed; 
                              transform: none; box-shadow: none; }
        
        .status-message { padding: 20px; margin: 20px 0; text-align: center; border: 2px solid; 
                         font-family: 'Creepster', cursive; display: none; }
        .success { background: rgba(0, 68, 0, 0.3); color: #0f0; border-color: #0f0; }
        .error { background: rgba(68, 0, 0, 0.3); color: #f00; border-color: #f00; }
        
        .back-link { display: block; text-align: center; margin-top: 25px; color: #ccc; 
                    text-decoration: none; padding: 10px; border: 1px solid #333; 
                    font-family: 'Creepster', cursive; }
        .back-link:hover { color: #fff; border-color: #800; background: rgba(128, 0, 0, 0.1); }
    </style>
</head>
<body>
    <!-- Blood rain -->
    <div class="blood-drop"></div>
    <div class="blood-drop"></div>
    <div class="blood-drop"></div>
    
    <div class="page-container">
        <div class="publish-container">
            <h1>Publish Content</h1>
            
            <form id="publishForm">
                <div class="form-group">
                    <label for="title">Title *</label>
                    <input type="text" id="title" required maxlength="100" placeholder="Enter title">
                    <span class="upload-hint warning-hint">Required field</span>
                </div>
                
                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description" required maxlength="500" placeholder="Enter description"></textarea>
                    <span class="upload-hint">Maximum 500 characters</span>
                </div>
                
                <div class="form-group">
                    <label for="type">Content Type *</label>
                    <select id="type" required>
                        <option value="">Select type</option>
                        <option value="image">Image</option>
                        <option value="video">Video</option>
                        <option value="link">Link</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="link">Direct Link *</label>
                    <input type="url" id="link" required placeholder="https://example.com/file.jpg">
                    <span class="upload-hint warning-hint">Paste direct link from hoster</span>
                    
                    <div class="hoster-links">
                        <a href="https://imagekit.io/dashboard/media-library" target="_blank" class="hoster-link">
                            Upload Videos/Images
                        </a>
                        <a href="https://imgbb.com/" target="_blank" class="hoster-link">
                            Upload Images
                        </a>
                    </div>
                    
                    <span class="upload-hint">
                        Upload to hoster, get direct link, paste here
                    </span>
                </div>
                
                <button type="submit" class="submit-btn" id="submitBtn">Publish Content</button>
            </form>
            
            <div id="statusMessage" class="status-message"></div>
            <a href="index.html" class="back-link">‚Üê Back to Viewer</a>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAyTSyWhLVe22jynP94cp9OEg6IC5-OhdE",
            authDomain: "leakstream-4f62f.firebaseapp.com",
            projectId: "leakstream-4f62f",
            storageBucket: "leakstream-4f62f.firebasestorage.app",
            messagingSenderId: "886997714546",
            appId: "1:886997714546:web:b7fcbb9b28010d5ec564eb",
            measurementId: "G-RXHE019ZWT"
        };

        // Initialize Firebase
        let db, auth;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase initialized successfully");
            }
            
            db = firebase.firestore();
            auth = firebase.auth();
            
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showStatus("Firebase initialization failed", "error");
        }

        // Show status message
        function showStatus(message, type = 'error') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            
            // Scroll to message
            statusDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            if (type === 'success') {
                setTimeout(() => statusDiv.style.display = 'none', 3000);
            }
        }

        // Create blood rain
        function createBloodRain() {
            for (let i = 0; i < 20; i++) {
                let drop = document.createElement('div');
                drop.className = 'blood-drop';
                drop.style.left = Math.random() * 100 + 'vw';
                drop.style.animationDuration = Math.random() * 2 + 1 + 's';
                drop.style.opacity = Math.random() * 0.5 + 0.1;
                document.body.appendChild(drop);
            }
        }

        // Initialize app
        async function initializeApp() {
            try {
                console.log("Initializing publishing app...");
                
                // Sign in anonymously
                await auth.signInAnonymously();
                console.log("Signed in anonymously");
                
                // Setup form
                setupForm();
                
                // Create blood rain
                createBloodRain();
                
                showStatus("Ready to publish content", "success");
                
            } catch (error) {
                console.error("App initialization failed:", error);
                showStatus("Error connecting to database", "error");
            }
        }

        // Setup form
        function setupForm() {
            const form = document.getElementById('publishForm');
            const submitBtn = document.getElementById('submitBtn');
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const title = document.getElementById('title').value.trim();
                const description = document.getElementById('description').value.trim();
                const type = document.getElementById('type').value;
                const link = document.getElementById('link').value.trim();
                
                // Validation
                if (!title || !description || !type || !link) {
                    showStatus("Please fill all required fields", "error");
                    return;
                }
                
                try {
                    new URL(link);
                } catch {
                    showStatus("Please enter a valid URL", "error");
                    return;
                }
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'Publishing...';
                
                try {
                    const user = auth.currentUser;
                    
                    if (!user) {
                        throw new Error("Not authenticated");
                    }
                    
                    // Create post
                    await db.collection('posts').add({
                        title: title,
                        description: description,
                        type: type,
                        link: link,
                        userId: user.uid,
                        spamReports: 0,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    console.log("Post created successfully");
                    
                    // Show success
                    showStatus("Content published successfully! Redirecting...", "success");
                    
                    // Reset form
                    form.reset();
                    
                    // Redirect to viewer
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    
                } catch (error) {
                    console.error("Error publishing:", error);
                    
                    if (error.code === 'permission-denied') {
                        showStatus("Permission denied. Check Firestore rules.", "error");
                    } else {
                        showStatus("Error publishing content. Please try again.", "error");
                    }
                    
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Publish Content';
                }
            });
        }

        // Start app
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
